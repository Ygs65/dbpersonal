<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <title>FlashBattle Pro 考場 (tqcexam)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1976d2" />
  <link rel="manifest" href="/manifest.json">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #e3f2fd 0, #f5f5f5 50%, #fafafa 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app {
      width: 100%;
      max-width: 1080px;
      margin: 12px;
      padding: 14px 16px 20px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 18px;
      box-shadow: 0 10px 32px rgba(25, 118, 210, 0.16);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 6px;
      text-align: center;
    }

    .subtitle {
      font-size: .8rem;
      text-align: center;
      color: #546e7a;
      margin-bottom: 10px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      align-items: center;
      justify-content: space-between;
      font-size: .8rem;
      padding: 6px 8px;
      border-radius: 12px;
      background: #f5f9ff;
      border: 1px solid #e3f2fd;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: .8rem;
      cursor: pointer;
      background: linear-gradient(135deg, #1976d2, #1565c0);
      color: #fff;
      box-shadow: 0 3px 8px rgba(21, 101, 192, 0.28);
      white-space: nowrap;
      transition: transform .08s, box-shadow .12s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 13px rgba(21, 101, 192, 0.3);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(21, 101, 192, 0.25);
    }

    .btn.secondary {
      background: #eceff1;
      color: #37474f;
      box-shadow: none;
    }

    .btn.danger {
      background: linear-gradient(135deg, #e53935, #c62828);
      box-shadow: 0 3px 8px rgba(229, 57, 53, 0.3);
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .timer {
      font-weight: 600;
      color: #c62828;
    }

    .main {
      display: grid;
      grid-template-columns: 2.3fr 1.2fr;
      gap: 12px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border-radius: 14px;
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      background: linear-gradient(135deg, #fafafa, #ffffff);
      box-shadow: 0 3px 9px rgba(0, 0, 0, .04);
    }

    .card-title {
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question {
      border-radius: 10px;
      border: 1px solid #eceff1;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #ffffff;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 8px;
    }

    .q-title {
      font-size: .9rem;
      font-weight: 600;
    }

    .q-topic {
      font-size: .75rem;
      color: #546e7a;
    }

    .options {
      margin-top: 4px;
      padding-left: 4px;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
      font-size: .85rem;
    }

    .option-item input {
      flex: 0 0 auto;
    }

    .option-label {
      flex: 1;
    }

    .q-meta {
      font-size: .75rem;
      color: #78909c;
      margin-top: 4px;
    }

    .summary-text {
      font-size: .85rem;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      padding: 6px 8px;
      font-size: .8rem;
      resize: vertical;
    }

    input[type=file] {
      font-size: .8rem;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>FlashBattle Pro 考場</h1>
    <div class="subtitle">
      本頁負責「多題作答」及計分，並把結果送回 Redis：<code>/api/exam_result</code>。<br>
      若由房間啟動，會自動載入房主指定的題庫與時間限制；否則為個人練習模式，可自行匯入 JSON 題庫。
    </div>

    <div class="top-bar">
      <div>
        <span id="modeTag" class="tag">模式：偵測中...</span>
      </div>
      <div>
        玩家：<span id="playerInfo"></span>
        ｜ 房間：<span id="roomInfo"></span>
        ｜ 題庫：<span id="bankInfo"></span>
      </div>
      <div>
        剩餘時間：<span id="timer" class="timer">未啟動</span>
      </div>
      <div>
        <button id="btnBackHome" class="btn secondary">回首頁 / 房間大廳</button>
        <button id="btnSubmit" class="btn danger">交卷（送出成績）</button>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="card-title">
          題目區
        </div>
        <div id="questionList"></div>
      </div>
      <div class="card">
        <div class="card-title">
          作答資訊 / 匯入題庫（個人模式用）
        </div>
        <div class="summary-text" id="summaryBox">
          尚未載入題目。若是房間啟動的考試，請等待房主指令；若是個人模式，可在下方匯入 JSON 題庫。
        </div>
        <hr style="margin:8px 0;">
        <div id="personalImportBox">
          <div style="font-size:.8rem;margin-bottom:4px;">
            個人練習模式：請匯入 JSON 題庫檔（格式：<code>[{ text, options, answers, type, topic, tag, explanation }...]</code>）。
          </div>
          <input type="file" id="fileInput" accept=".json">
          <div style="margin:4px 0;font-size:.75rem;color:#78909c;">
            或直接貼上 JSON 文字：
          </div>
          <textarea id="jsonInput" placeholder='[{"text":"1+1=?","options":["1","2"],"answers":[1],"type":"single"}]'></textarea>
          <button id="btnLoadJson" class="btn" style="margin-top:6px;">載入為個人題庫</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ROOM_RULES_KEY = 'fb_room_exam_rules';
    const PLAYER_PROFILE_KEY = 'fb_player_profile_v1';

    const modeTag = document.getElementById('modeTag');
    const playerInfoEl = document.getElementById('playerInfo');
    const roomInfoEl = document.getElementById('roomInfo');
    const bankInfoEl = document.getElementById('bankInfo');
    const timerEl = document.getElementById('timer');
    const questionListEl = document.getElementById('questionList');
    const summaryBox = document.getElementById('summaryBox');
    const personalImportBox = document.getElementById('personalImportBox');

    const btnBackHome = document.getElementById('btnBackHome');
    const btnSubmit = document.getElementById('btnSubmit');
    const fileInput = document.getElementById('fileInput');
    const jsonInput = document.getElementById('jsonInput');
    const btnLoadJson = document.getElementById('btnLoadJson');

    let playerId = 'guest';
    let playerName = 'Player';
    let mode = 'personal';
    let roomId = '';
    let bankId = '';
    let questions = [];
    let timeLimitMinutes = 0;
    let timerRemainSec = 0;
    let timerHandle = null;
    const answersMap = {}; // qIndex -> [optionIndex]

    function loadProfile() {
      try {
        const raw = localStorage.getItem(PLAYER_PROFILE_KEY);
        if (!raw) return;
        const p = JSON.parse(raw);
        if (p.playerId) playerId = p.playerId;
        if (p.name) playerName = p.name;
      } catch (e) { }
    }

    function detectRoomRules() {
      try {
        const raw = localStorage.getItem(ROOM_RULES_KEY);
        if (!raw) {
          mode = 'personal';
          return;
        }
        const rules = JSON.parse(raw);
        if (!rules || !rules.questions || rules.questions.length === 0) {
          mode = 'personal';
          return;
        }
        mode = 'room';
        roomId = rules.roomId || '';
        bankId = rules.bankId || '';
        questions = normalizeQuestions(rules.questions);
        timeLimitMinutes = Number(rules.timeLimitMinutes || 0);
      } catch (e) {
        mode = 'personal';
      }
    }

    function normalizeQuestions(rawQs) {
      if (!Array.isArray(rawQs)) return [];
      return rawQs.map((q) => {
        const text = q.text || q.question || '';
        const options = Array.isArray(q.options) ? q.options : [];
        let answers = [];
        if (Array.isArray(q.answers)) {
          answers = q.answers.map(x => Number(x)).filter(x => !isNaN(x));
        } else if (typeof q.answer === 'number') {
          answers = [q.answer];
        } else if (typeof q.answers === 'string') {
          answers = q.answers.split(',').map(x => parseInt(x, 10)).filter(x => !isNaN(x));
        }
        const type = q.type || (answers.length > 1 ? 'multi' : 'single');
        const topic = q.topic || '';
        const tag = q.tag || '';
        const explanation = q.explanation || '';
        return { text, options, answers, type, topic, tag, explanation };
      }).filter(q => q.text && q.options.length >= 2);
    }

    function renderHeader() {
      playerInfoEl.textContent = `${playerName} (${playerId})`;
      if (mode === 'room') {
        modeTag.textContent = '模式：房間競賽';
        roomInfoEl.textContent = roomId || '無';
        bankInfoEl.textContent = bankId || '未指定';
        personalImportBox.style.display = 'none';
      } else {
        modeTag.textContent = '模式：個人練習';
        roomInfoEl.textContent = '（個人模式）';
        bankInfoEl.textContent = bankId || '自訂題庫';
        personalImportBox.style.display = 'block';
      }
    }

    function renderQuestions() {
      questionListEl.innerHTML = '';
      if (!questions || questions.length === 0) {
        const p = document.createElement('p');
        p.textContent = '目前尚未載入題目。請匯入 JSON 題庫，或回首頁由房主啟動考試。';
        p.style.color = '#888';
        p.style.fontSize = '.85rem';
        questionListEl.appendChild(p);
        summaryBox.textContent = '尚未載入題目。';
        return;
      }
      questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question';

        const header = document.createElement('div');
        header.className = 'question-header';

        const title = document.createElement('div');
        title.className = 'q-title';
        title.textContent = `Q${idx + 1}. ${q.text}`;

        const topic = document.createElement('div');
        topic.className = 'q-topic';
        topic.textContent = (q.topic ? `主題：${q.topic} ｜` : '') + (q.type === 'multi' ? '多選題' : '單選題');

        header.appendChild(title);
        header.appendChild(topic);
        qDiv.appendChild(header);

        const optWrap = document.createElement('div');
        optWrap.className = 'options';

        q.options.forEach((opt, optIdx) => {
          const optDiv = document.createElement('label');
          optDiv.className = 'option-item';

          const input = document.createElement('input');
          input.type = q.type === 'multi' ? 'checkbox' : 'radio';
          input.name = `q_${idx}`;
          input.value = String(optIdx);

          input.addEventListener('change', () => {
            if (q.type === 'multi') {
              const arr = answersMap[idx] || [];
              if (input.checked) {
                if (!arr.includes(optIdx)) arr.push(optIdx);
              } else {
                const i = arr.indexOf(optIdx);
                if (i >= 0) arr.splice(i, 1);
              }
              answersMap[idx] = arr;
            } else {
              answersMap[idx] = [optIdx];
              // 同一題其他 radio 不需額外處理，瀏覽器自己會管
            }
          });

          const label = document.createElement('span');
          label.className = 'option-label';
          const letter = String.fromCharCode(65 + optIdx);
          label.textContent = `${letter}. ${opt}`;

          optDiv.appendChild(input);
          optDiv.appendChild(label);
          optWrap.appendChild(optDiv);
        });

        qDiv.appendChild(optWrap);

        const meta = document.createElement('div');
        meta.className = 'q-meta';
        meta.textContent = q.tag ? `標籤：${q.tag}` : '';
        qDiv.appendChild(meta);

        questionListEl.appendChild(qDiv);
      });

      summaryBox.textContent = `已載入 ${questions.length} 題。請作答後按「交卷」。`;
    }

    function startTimer() {
      if (!timeLimitMinutes || timeLimitMinutes <= 0) {
        timerEl.textContent = '未限制';
        return;
      }
      timerRemainSec = timeLimitMinutes * 60;
      updateTimerText();
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(() => {
        timerRemainSec--;
        if (timerRemainSec <= 0) {
          clearInterval(timerHandle);
          timerEl.textContent = '時間到，自動交卷中...';
          submitExam(true);
        } else {
          updateTimerText();
        }
      }, 1000);
    }

    function updateTimerText() {
      const m = Math.floor(timerRemainSec / 60);
      const s = timerRemainSec % 60;
      timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function gradeExam() {
      const total = questions.length;
      let correct = 0;
      const wrongDetailList = [];

      const isSameSet = (a, b) => {
        if (!Array.isArray(a) || !Array.isArray(b)) return false;
        if (a.length !== b.length) return false;
        const aa = [...a].sort();
        const bb = [...b].sort();
        return aa.every((v, i) => v === bb[i]);
      };

      questions.forEach((q, idx) => {
        const std = Array.isArray(q.answers)
          ? q.answers
          : (typeof q.answer === 'number' ? [q.answer] : []);
        const user = answersMap[idx] || [];

        let ok = false;
        if (q.type === 'multi' || std.length > 1) {
          ok = isSameSet(std, user);
        } else {
          ok = user.length === 1 && std.length === 1 && user[0] === std[0];
        }

        if (ok) {
          correct++;
        } else {
          wrongDetailList.push({
            id: idx + 1,
            text: q.text,
            topic: q.topic || '',
            tag: q.tag || '',
            options: q.options || [],
            answers: std,
            userAnswer: user,
            bankId,
            explanation: q.explanation || ''
          });
        }
      });

      const score = total > 0 ? Math.round(100 * correct / total) : 0;
      return { total, correct, score, wrongDetailList };
    }

    async function submitExam(auto = false) {
      if (!questions || questions.length === 0) {
        alert('尚未載入題目。');
        return;
      }
      if (!auto) {
        const ok = confirm('確定要交卷並送出成績嗎？');
        if (!ok) return;
      }
      btnSubmit.disabled = true;

      const { total, correct, score, wrongDetailList } = gradeExam();
      const modeLabel = mode === 'room' ? 'room' : 'personal';

      const summary = [];
      summary.push(`作答完畢！`);
      summary.push(`總題數：${total}`);
      summary.push(`答對題數：${correct}`);
      summary.push(`得分：${score} 分`);
      summary.push(`錯題數：${wrongDetailList.length}`);
      summary.push('（系統已將成績與錯題送回 Redis，首頁會更新排行榜與我的成績。）');
      summaryBox.textContent = summary.join('\n');

      try {
        await fetch('/api/exam_result', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            playerId,
            name: playerName,
            mode: modeLabel,
            roomId: roomId || '',
            bankId: bankId || '',
            score,
            total,
            correctCount: correct,
            wrongQuestions: wrongDetailList
          })
        });
      } catch (e) {
        console.error('submit exam_result failed', e);
      }

      // 房間模式交卷後清掉規則，避免上一場影響下一場
      if (mode === 'room') {
        try { localStorage.removeItem(ROOM_RULES_KEY); } catch (e) { }
      }
    }

    btnSubmit.addEventListener('click', () => submitExam(false));

    btnBackHome.addEventListener('click', () => {
      window.location.href = '/';
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          questions = normalizeQuestions(Array.isArray(data.questions) ? data.questions : data);
          mode = 'personal';
          roomId = '';
          bankId = file.name.replace(/\.[^.]+$/, '');
          renderHeader();
          renderQuestions();
          summaryBox.textContent = `已從檔案載入 ${questions.length} 題。`;
          timeLimitMinutes = 0;
          timerEl.textContent = '未限制';
        } catch (e) {
          alert('JSON 格式解析錯誤。');
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    btnLoadJson.addEventListener('click', () => {
      const txt = jsonInput.value.trim();
      if (!txt) {
        alert('請先貼上 JSON 文字。');
        return;
      }
      try {
        const data = JSON.parse(txt);
        questions = normalizeQuestions(Array.isArray(data.questions) ? data.questions : data);
        mode = 'personal';
        roomId = '';
        bankId = 'json手動貼上';
        renderHeader();
        renderQuestions();
        summaryBox.textContent = `已從文字載入 ${questions.length} 題。`;
        timeLimitMinutes = 0;
        timerEl.textContent = '未限制';
      } catch (e) {
        alert('JSON 格式解析錯誤。');
      }
    });

    (function init() {
      loadProfile();
      detectRoomRules();
      renderHeader();
      renderQuestions();
      if (mode === 'room' && questions.length > 0 && timeLimitMinutes > 0) {
        startTimer();
        summaryBox.textContent =
          `房間測驗已就緒：共 ${questions.length} 題，限時 ${timeLimitMinutes} 分鐘。請開始作答，時間到會自動交卷。`;
      }
    })();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(() => { });
      });
    }
  </script>
</body>

</html>
